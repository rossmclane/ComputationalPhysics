<!DOCTYPE html>
<html>
<head>
<script>

/*=========================================================================
 * Declaring global variables
 *=========================================================================
 */
var log = console.log ;
var env = {} ; /*   A single global variable to pass 
                    variables between functions         */

/*=========================================================================
 * Function to convert hex format to a rgb color
 *=========================================================================
 */
function rgb2hex(r,g,b,a){
 return "#" +
  ("0" + parseInt(r,10).toString(16)).slice(-2) +
  ("0" + parseInt(g,10).toString(16)).slice(-2) +
  ("0" + parseInt(b,10).toString(16)).slice(-2) ;
}
/*=========================================================================
 * Get relevant X and Y coordinate on canvas
 *=========================================================================
 */
function getCanvasXY(e,p){
    output={} ;
    output.x = ((p.x-e.xmin)/(e.xmax-e.xmin))*e.width ;
    output.y = (1.-(p.y-e.ymin)/(e.ymax-e.ymin))*e.height ;
    return output ;
}

/*=========================================================================
 * get coordinates of a point on the circle 
 *=========================================================================
 */
function getPointOnTrajectory(env){
    var p = {} ;
    //env.velocity_x      = env.velocity*Math.cos(env.angle) ;
    //env.velocity_y      = env.velocity*Math.sin(env.angle) ;

    var t = env.dt*env.iterNo ;
    p.x = env.x0 + env.velocity_x*t/(env.velocity*6.) ;
    p.y = env.y0 + (env.velocity_y*t -0.5*env.g*t*t)/(env.velocity*3) ;
    //env.some = getCanvasXY(env.setup,{x:0,y:env.setup.ymin})
    if (p.y < env.y0) {
        if (p.y < -.02) {
            env.drawing=!env.drawing;
        }
        env.iterNo = 0 ;
        var t = env.dt*env.iterNo ;
        env.x0 = p.x ;
        env.y0 = p.y ;
        env.velocity_x = env.damp.value * env.velocity_x ;
        env.velocity_y = env.damp.value * env.velocity_y ;
        p.x = env.x0  + env.velocity_x*t/(env.velocity*6.) ;
        p.y = env.y0  + (env.velocity_y*t -0.5*env.g*t*t)/(env.velocity*3) ;
        console.log(p.y)
    }
    //  Write the appropriate condition here for the ball to bounce
    return p ;
}

/*=========================================================================
 * Entry point of the program
 *=========================================================================
 */
function load(){
    env.dCnvs           = document.getElementById(  "drawing"   ) ;
    env.cCnvs           = document.createElement(   "canvas"    ) ;

    env.width           = env.dCnvs.width ;
    env.height          = env.dCnvs.height ;
    env.cCnvs.width     = env.width ;
    env.cCnvs.height    = env.height ;

    env.setup={} ;
    env.setup.width     = env.width ;
    env.setup.height    = env.height ;

    env.setup.xmin      = -.1 ;
    env.setup.xmax      = 1.1 ;
    env.setup.ymin      = -.1 ;
    env.setup.ymax      = .5 ;

    env.dCtx = env.dCnvs.getContext("2d") ;
    env.cCtx = env.cCnvs.getContext('2d') ;

    env.g               = 9.81 ;
    env.initialVelocity = 30.0 ;
    env.velocity        = env.initialVelocity ;
    env.angle           = 65*Math.PI/180 ;
    env.x0 = 0 ;
    env.y0 = 0 ;
    env.velocity_x      = env.velocity*Math.cos(env.angle) ;
    env.velocity_y      = env.velocity*Math.sin(env.angle) ;

    env.elast = 0.6 ;
  
    env.dt              = 0.04 ;
    env.noIterations    = 400 ;
    env.iterNo = 0 ;

    env.p = getPointOnTrajectory(env) ;
    log(env.p) ;

    env.drawing = false ;

    env.barrel         = new Image() ;
    env.ball       = new Image() ;

    env.barrel.src     = 'barrel.png' ;
    env.barrel.scale   = 0.1 ;
    env.ball.src   = 'ball.png' ;
    env.ball.scale = 0.03 ;


    /* Get Coordinate of Point (0,0) on Canvas */
    env.pOnC = getCanvasXY(env.setup, {x:1, y:0} ) ;
    
    /* Move the drawing position to coordinate of the point */
    env.cCtx.translate(env.pOnC.x , env.pOnC.y) ;
    /* Scale the image in x and y direction */
    env.cCtx.scale(env.barrel.scale,env.barrel.scale) ;
    /* draw the image on cCtx */
    env.cCtx.drawImage(env.barrel, -env.barrel.width/2.0, -env.barrel.height) ;
    /* Set transformation matrix to unity */
    env.cCtx.setTransform(1,0,0,1,0,0) ;
    
    /* draw the cCnvs over dCtx */
    env.dCtx.drawImage(env.cCnvs,0.,0.) ;

    /* Draw Earth on the original location of it */
    env.pOnD = getCanvasXY( env.setup, env.p) ;
    env.dCtx.translate(env.pOnD.x,env.pOnD.y) ;
    env.dCtx.scale(env.ball.scale, env.ball.scale) ;
    env.dCtx.drawImage(env.ball, -env.ball.width/2,-env.ball.height/2.) ;
    env.ball.onload = reset ;
    env.barrel.onload = reset ;
    draw() ;
}

/*=========================================================================
 * draw routine
 *=========================================================================
 */
function draw(){
    if (env.drawing){
        env.iterNo++ ;
        resetContext(env.dCtx, env.width, env.height) ;
        
        env.damp = document.getElementById('damping');
        
        env.cCtx.beginPath() ;
        env.cCtx.strokeStyle = "#000000" ;
        env.cCtx.moveTo(env.pOnD.x, env.pOnD.y) ;
        env.p = getPointOnTrajectory(env) ;
        env.pOnD = getCanvasXY(env.setup, env.p) ;
        env.cCtx.lineTo(env.pOnD.x,env.pOnD.y) ;
        env.cCtx.stroke() ;
        
        env.dCtx.drawImage(env.cCnvs, 0,0) ;
        env.dCtx.translate(env.pOnD.x,env.pOnD.y) ;
        env.dCtx.scale(env.ball.scale,env.ball.scale) ;
        env.dCtx.drawImage(env.ball, -env.ball.width/2,-env.ball.height/2.) ;

        if ( env.iterNo > env.noIterations ){
            env.drawing = false ;
        }
    } 
    setTimeout(draw,10);
}

/*=========================================================================
 * Reset context 
 *=========================================================================
 */
function resetContext(c,w,h){
    c.setTransform(1,0,0,1,0,0) ;
    c.clearRect(0,0, w, h) ;
    c.beginPath() ;
}

/*=========================================================================
 * reset program
 *=========================================================================
 */
function reset(){
    resetContext(env.dCtx,env.width,env.height) ;
    resetContext(env.cCtx,env.width,env.height) ;

    env.iterNo=0 ;
    env.x0 = 0 ;
    env.y0 = 0 ;
    env.velocity        = env.initialVelocity ;
    env.velocity_x      = env.velocity*Math.cos(env.angle) ;
    env.velocity_y      = env.velocity*Math.sin(env.angle) ;

    env.p= getPointOnTrajectory(env) ;
    
    /* Get Coordinate of Point (0,0) on Canvas */
    env.pOnC = getCanvasXY(env.setup, {x:1, y:0} ) ;
    
    /* Move the drawing position to coordinate of the point */
    env.cCtx.translate(env.pOnC.x , env.pOnC.y) ;

    /* Scale the image in x and y direction */
    env.cCtx.scale(env.barrel.scale,env.barrel.scale) ;
    
    /* draw the image on cCtx */
    env.cCtx.drawImage(env.barrel, -env.barrel.width/2.0, -env.barrel.height) ;
    
    /* Set transformation matrix to unity */
    env.cCtx.setTransform(1,0,0,1,0,0) ;
    
    /* draw the cCnvs over dCtx */
    env.dCtx.drawImage(env.cCnvs,0.,0.) ;

    /* Draw Earth on the original location of it */
    env.pOnD = getCanvasXY( env.setup, env.p) ;
    env.dCtx.translate(env.pOnD.x,env.pOnD.y) ;
    env.dCtx.scale(env.ball.scale, env.ball.scale) ;
    env.dCtx.drawImage(env.ball, -env.ball.width/2,-env.ball.height/2.) ;

}
    
/*=========================================================================
 * reset program
 *=========================================================================
 */
function myFunction(){
    env.damp = document.getElementById('damping');
}

</script>
</head>
<body onload='load();'>
<h1>Bouncing Ball and Barrel</h1>
<canvas id="drawing" width="512" height="256" style="border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>
</br>
<form>
  Damping (0-1):<br>
  <input type="number" id = "damping" value=.7><br>
</form> 
<input type="submit" onclick="myFunction()" value="Set Values">    
<button onclick='env.drawing=!env.drawing;'>Draw/Pause</button> 
<button onclick='reset();'>Reset!</button>
</body>
</html>

