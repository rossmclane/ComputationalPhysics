<!DOCTYPE html>
<html>
<head>
<script>

/*=========================================================================
 * Declaring global variables
 *=========================================================================
 */
var log = console.log ;
var env = {} ; /*   A single global variable to pass 
                    variables between functions         */

/*=========================================================================
 * Function to convert hex format to a rgb color
 *=========================================================================
 */
function rgb2hex(r,g,b,a){
 return "#" +
  ("0" + parseInt(r,10).toString(16)).slice(-2) +
  ("0" + parseInt(g,10).toString(16)).slice(-2) +
  ("0" + parseInt(b,10).toString(16)).slice(-2) ;
}
/*=========================================================================
 * Get relevant X and Y coordinate on canvas
 *=========================================================================
 */
function getCanvasXY(e,p){
    output={} ;
    output.x = ((p.x-e.xmin)/(e.xmax-e.xmin))*e.width ;
    output.y = (1.-(p.y-e.ymin)/(e.ymax-e.ymin))*e.height ;
    return output ;
}

/*=========================================================================
 * get coordinates of a point on the circle 
 *=========================================================================
 */
function getPointOnCircle(env){
    var p = {} ;
    p.x = env.radius*Math.cos(.05 * 2.0*Math.PI*env.iterNo/env.noIterations) ;
    p.y = env.radius*Math.sin(.05 * 2.0 * Math.PI*env.iterNo/env.noIterations) ;
    return p ;
}

/*=========================================================================
 * Entry point of the program
 *=========================================================================
 */
function load(){
    env.dCnvs           = document.getElementById(  "drawing"   ) ;
    env.cCnvs           = document.createElement(   "canvas"    ) ;

    env.width           = env.dCnvs.width ;
    env.height          = env.dCnvs.height ;
    env.cCnvs.width     = env.width ;
    env.cCnvs.height    = env.height ;

    env.setup={} ;
    env.setup.width     = env.width ;
    env.setup.height    = env.height ;

    env.setup.xmin      = -1.3 ;
    env.setup.xmax      = 1.3 ;
    env.setup.ymin      = -1.3 ;
    env.setup.ymax      = 1.3 ;

    env.dCtx = env.dCnvs.getContext("2d") ;
    env.cCtx = env.cCnvs.getContext('2d') ;

    env.radius          = .5 ;
    env.noIterations    = 360 ;
    env.iterNo = 0 ;
    env.p = getPointOnCircle(env) ;

    env.drawing = false ;

    env.sun         = new Image() ;
    env.earth       = new Image() ;
    env.moon        = new Image() ;

    env.sun.src     = 'sun.png' ;
    env.sun.scale   = .4 ;
    env.earth.src   = 'earth.png' ;
    env.earth.scale = 0.1 ;
    env.moon.src    = 'moon.png'
    env.moon.scale  = .08 ;


    /* Get Coordinate of Point (0,0) on Canvas */
    env.pOnC = getCanvasXY(env.setup, {x:0, y:0} ) ;
    
    /* Move the drawing position to coordinate of the point */
    env.cCtx.translate(env.pOnC.x , env.pOnC.y) ;
    /* Scale the image in x and y direction */
    env.cCtx.scale(env.sun.scale,env.sun.scale) ;
    /* draw the image on cCtx */
    env.cCtx.drawImage(env.sun, -env.sun.width/2.0, -env.sun.height/2.0) ;
    /* Set transformation matrix to unity */
    env.cCtx.setTransform(1,0,0,1,0,0) ;
    
    /* draw the cCnvs over dCtx (Right now just drawing the sun onto the dCnvs) */
    env.dCtx.drawImage(env.cCnvs,0.,0.) ;

    /* Draw Earth on the original location of it */
    env.pOnD = getCanvasXY( env.setup, env.p) ; /* gets the original point of the Earth on the canvas*/
    env.dCtx.translate(env.pOnD.x,env.pOnD.y) ; /* translates the coordinate system to that point and draws the Earth*/
    env.dCtx.scale(env.earth.scale, env.earth.scale) ;
    env.dCtx.drawImage(env.earth, -env.earth.width/2,-env.earth.height/2.) ;
    
    /* Draw Moon on original location */
    env.dCtx.rotate(-.65 * 2.0*Math.PI*env.iterNo/env.noIterations) ;
    env.dCtx.translate(0,350) ;
    env.dCtx.scale(env.moon.scale, env.moon.scale) ;
    env.dCtx.drawImage(env.moon, -env.moon.width/2,-env.moon.height/2.) ;
    
    
    env.earth.onload = reset ;
    env.sun.onload = reset ;
    env.moon.onload = reset ;
    draw() ;
}

/*=========================================================================
 * draw routine
 *=========================================================================
 */
function draw(){
    if (env.drawing){
        env.iterNo++ ;
        resetContext(env.dCtx, env.width, env.height) ;
        
        /* All of this is being drawn on cCnvs */
        env.cCtx.beginPath() ;
        env.cCtx.strokeStyle = "#000000" ;
        env.cCtx.moveTo(env.pOnD.x, env.pOnD.y) ; /* moves to the starting point of the Earth*/
        env.p = getPointOnCircle(env) ; /* sets new point due to env.iterNo*/
        env.pOnD = getCanvasXY(env.setup, env.p) ; /* sets env.PonD to get that new point on the canvas*/
        env.cCtx.lineTo(env.pOnD.x,env.pOnD.y) ; /* draws a line to the new point*/
        env.cCtx.stroke() ;  /* fills the line */
        
        env.dCtx.drawImage(env.cCnvs, 0,0) ; /* The coordinate system is still translated to the start of earth x & y */
        env.dCtx.translate(env.pOnD.x ,env.pOnD.y) ; /* Translates coords from old earth x&y to new earth x&y */
        env.dCtx.scale(env.earth.scale,env.earth.scale) ;
        env.dCtx.drawImage(env.earth, -env.earth.width/2,-env.earth.height/2.) ; /* draws the earth */
        
        env.dCtx.rotate(-2.0*.65*Math.PI*env.iterNo/env.noIterations) ;
        env.dCtx.translate(0,350) ;
        env.dCtx.scale(env.moon.scale, env.moon.scale) ;
        env.dCtx.drawImage(env.moon, -env.moon.width/2,-env.moon.height/2.) ;
        
        /* So now the coordinate system is in this new location if I rotate it and translate and plot the moon and use iterNo to iterate through the cycle maybe that will work */

        /*if ( env.iterNo > env.noIterations*0.9 ){
            env.drawing = false ;
        }*/
    } 
    setTimeout(draw,10);
}

/*=========================================================================
 * Reset context 
 *=========================================================================
 */
function resetContext(c,w,h){
    c.setTransform(1,0,0,1,0,0) ;
    c.clearRect(0,0, w, h) ;
    c.beginPath() ;
}

/*=========================================================================
 * reset program
 *=========================================================================
 */
function reset(){
    resetContext(env.dCtx,env.width,env.height) ;
    resetContext(env.cCtx,env.width,env.height) ;

    env.iterNo=0 ;
    env.p= getPointOnCircle(env) ;
    
    /* Get Coordinate of Point (0,0) on Canvas */
    env.pOnC = getCanvasXY(env.setup, {x:0, y:0} ) ;
    
    /* Move the drawing position to coordinate of the point */
    env.cCtx.translate(env.pOnC.x , env.pOnC.y) ;

    /* Scale the image in x and y direction */
    env.cCtx.scale(env.sun.scale,env.sun.scale) ;
    
    /* draw the image on cCtx */
    env.cCtx.drawImage(env.sun, -env.sun.width/2.0, -env.sun.height/2.0) ;
    
    /* Set transformation matrix to unity */
    env.cCtx.setTransform(1,0,0,1,0,0) ;
    
    /* draw the cCnvs over dCtx */
    env.dCtx.drawImage(env.cCnvs,0.,0.) ;

    /* Draw Earth on the original location of it */
    env.pOnD = getCanvasXY( env.setup, env.p) ;
    env.dCtx.translate(env.pOnD.x,env.pOnD.y) ;
    env.dCtx.scale(env.earth.scale, env.earth.scale) ;
    env.dCtx.drawImage(env.earth, -env.earth.width/2,-env.earth.height/2.) ;
    
    /* Draw Moon on original location */
    env.dCtx.rotate(1.5*2.0*Math.PI*env.iterNo/env.noIterations) ;
    env.dCtx.translate(0,350) ;
    env.dCtx.scale(env.moon.scale, env.moon.scale) ;
    env.dCtx.drawImage(env.moon, -env.moon.width/2,-env.moon.height/2.) ;
    

}

</script>
</head>
<body onload='load();'>
<h1>Earch and Sun</h1>
    <p> The moon makes about 13 revolutions around the Earth in a calendar year. This detail is presented here: If one revolution around the sun is a year, then the moon makes about 13 revolutions around the earth in the same time. </p>
<canvas id="drawing" width="512" height="512" style="border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>
</br>
<button onclick='env.drawing=!env.drawing;'>Draw/Pause</button>
<button onclick='reset();'>Reset!</button>
</body>
</html>

